<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DeepSeek Chat</title>
  <style>
    :root {
      --primary-color: #5b8cff;
      --button-bg: #f8f9fb;
      --button-hover-bg: #e9ecef;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      min-width: 100vw;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    }
    .chat-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 60%;
      height: 100%;
      padding: 20px;
      background: transparent; /* 移除背景 */
      border-radius: 0; /* 移除圆角 */
      box-shadow: none; /* 移除阴影 */
      text-align: center;
    }
    .chat-icon {
      margin-bottom: 20px;
    }
    .chat-icon img {
      width: 80px;
      height: 80px;
    }
    .chat-options {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 12px;
      margin: 20px 0;
    }
    .chat-option {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10px 20px;
      background: var(--button-bg);
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 0.9rem;
      color: #333;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .chat-option:hover {
      background: var(--button-hover-bg);
    }
    .chat-messages {
      flex: 1;
      width: 100%;
      padding: 20px;
      padding-bottom: 80px; /* 添加底部内边距，防止内容被聊天框遮挡 */
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .chat-message {
      max-width: 75%;
      padding: 16px 20px;
      border-radius: 20px;
      line-height: 1.5;
      animation: messageAppear 0.3s ease-out;
      position: relative;
      word-break: break-word;
    }
    .chat-message.user {
      background: linear-gradient(135deg, #5b8cff 0%, #3d6ef7 100%);
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
      box-shadow: var(--shadow);
    }
    .chat-message.bot {
      background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
      color: #2d3748;
      align-self: flex-start;
      border-bottom-left-radius: 4px;
      box-shadow: var(--shadow);
    }
    .chat-input {
      width: 100%;
      max-width: 800px;
      display: flex;
      gap: 12px;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 10px;
      border-radius: 16px;
      box-shadow: var(--shadow);
    }
    .chat-input input {
      flex: 1;
      padding: 14px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }
    .chat-input button {
      padding: 10px 20px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .chat-input button:hover {
      background: #407bff;
    }
    @keyframes messageAppear {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
<div class="chat-container">
  <!-- 图标区域 -->
  <div class="chat-icon">
    <img th:src="@{/img/aichat_icon2.png}">
  </div>
  <!-- 选项按钮区域 -->
  <div class="chat-options">
    <div class="chat-option" onclick="sendPredefinedMessage('计算机学生应该怎么发展？')">计算机学生应该怎么发展？</div>
    <div class="chat-option" onclick="sendPredefinedMessage('土木老哥应该如何突破时代局限？')">土木老哥应该如何突破时代局限？</div>
    <div class="chat-option" onclick="sendPredefinedMessage('帮我设计一个408复习规划表')">帮我设计一个408复习规划表</div>
    <div class="chat-option" onclick="sendPredefinedMessage('报考长安大学计算机科学与技术的难度如何？')">报考长安大学计算机科学与技术的难度如何？</div>
    <div class="chat-option" onclick="sendPredefinedMessage('考研失败应该怎么规划调剂？')">考研失败应该怎么规划调剂？</div>
    <div class="chat-option" onclick="sendPredefinedMessage('生化环材天坑专业的考研前景如何？')">生化环材天坑专业的考研前景如何？</div>
  </div>
  <!-- 消息展示区域 -->
  <div class="chat-messages" id="chatMessages"></div>
  <!-- 输入区域 -->
  <div class="chat-input">
    <input type="text" id="questionInput" placeholder="和考研智导机器人聊聊..." onkeydown="handleKeyDown(event)">
    <button id="sendButton" disabled>发送</button>
  </div>
</div>

<script>
  const questionInput = document.getElementById('questionInput');
  const sendButton = document.getElementById('sendButton');
  const chatMessages = document.getElementById('chatMessages');
  let isBotResponding = false;

  // 输入验证
  questionInput.addEventListener('input', () => {
    sendButton.disabled = questionInput.value.trim().length === 0;
  });

  // 回车发送
  function handleKeyDown(e) {
    if (e.key === 'Enter' && !sendButton.disabled && !isBotResponding) {
      sendButton.click();
    }
  }

  // 发送逻辑
  sendButton.addEventListener('click', async () => {
    if (isBotResponding) return;

    const question = questionInput.value.trim();
    if (!question) return;

    questionInput.value = '';
    sendButton.disabled = true;
    isBotResponding = true;

    displayMessage('user', question);

    try {
      const typingIndicator = createTypingIndicator();

      const response = await fetch('/deepSeek/chat', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'text/event-stream',
        },
        body: JSON.stringify({ question }),
      });

      typingIndicator.remove();
      await handleBotResponse(response);
    } catch (error) {
      displayMessage('bot', 'Error: Unable to process your request.');
    } finally {
      isBotResponding = false;
      questionInput.focus();
    }
  });

  // 处理流式响应
  async function handleBotResponse(response) {
    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let currentBotMessage = displayMessage('bot', '');

    try {
      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop() || '';

        lines.forEach((line) => {
          if (line.startsWith('data:')) {
            const data = line.replace(/^data:\s*/, '').trim();
            if (data === '[DONE]') return;
            currentBotMessage.textContent += data;
          }
        });

        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    } finally {
      currentBotMessage = null;
    }
  }

  // 显示消息
  function displayMessage(sender, content) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message ${sender}`;
    messageDiv.textContent = content;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return messageDiv;
  }

  // 创建打字指示器
  function createTypingIndicator() {
    const container = document.createElement('div');
    container.className = 'typing-indicator';
    container.innerHTML = `
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
      <div class="typing-dot"></div>
    `;
    chatMessages.appendChild(container);
    chatMessages.scrollTop = chatMessages.scrollHeight;
    return container;
  }

  // 发送预定义消息
  function sendPredefinedMessage(message) {
    chatMessages.style.display = 'flex'; // 显示消息区域
    //displayMessage('user', message);
    questionInput.value = message;
    sendButton.disabled = false;
    //sendButton.click();
  }
</script>
</body>
</html>